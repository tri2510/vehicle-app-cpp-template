# üéì Step 2: Multi-Signal Processor Tutorial

## üìö Learning Objectives

In this second step, you'll advance to handling multiple vehicle signals:

- **Multi-Signal Subscription**: Subscribe to speed, RPM, and fuel level together
- **Data Correlation**: Analyze relationships between different signals
- **State Management**: Track comprehensive vehicle state efficiently  
- **Derived Metrics**: Calculate fuel efficiency and driving patterns

**Difficulty**: ‚≠ê‚≠ê Intermediate | **Time**: 30 minutes

## üéØ What You'll Build

A multi-signal processing application that:
- Monitors Vehicle.Speed, Engine.Speed (RPM), and FuelSystem.Level simultaneously
- Correlates data to detect driving patterns
- Calculates real-time fuel efficiency
- Provides comprehensive vehicle status reports
- Generates intelligent alerts based on combined signals

## üìã Prerequisites

**Required Setup:**
```bash
# Ensure KUKSA databroker is running
docker ps | grep velocitas-vdb || docker compose -f docker-compose.dev.yml up -d vehicledatabroker

# Reuse persistent volumes from Step 1 (or create new ones)
docker volume ls | grep tutorial-build || docker volume create tutorial-build
docker volume ls | grep tutorial-deps || docker volume create tutorial-deps  
docker volume ls | grep tutorial-vss || docker volume create tutorial-vss
```

**Container Image Options:**
```bash
# Option A: Use pre-built image (RECOMMENDED - instant start!)
# Throughout this tutorial, we'll use:
# ghcr.io/tri2510/vehicle-app-cpp-template/velocitas-quick:prerelease-latest

# Option B: Build locally (if you haven't already)
docker build -f Dockerfile.quick -t velocitas-quick .
```

## üß™ Step-by-Step Tutorial

### **Phase 1: Build the Multi-Signal Application**

**Using Pre-built Image (Recommended):**
```bash
# Build Step 2 application with persistent storage
docker run --rm --network host \
  -v tutorial-build:/quickbuild/build \
  -v tutorial-deps:/home/vscode/.conan2 \
  -v tutorial-vss:/quickbuild/app/vehicle_model \
  -e SDV_VEHICLEDATABROKER_ADDRESS=127.0.0.1:55555 \
  -v $(pwd)/examples/Step2_MultiSignalProcessor.cpp:/app.cpp \
  ghcr.io/tri2510/vehicle-app-cpp-template/velocitas-quick:prerelease-latest build --skip-deps --verbose
```

**Expected Build Output:**
```
‚úÖ [SUCCESS] Source validated: /app.cpp (385 lines)
‚úÖ [SUCCESS] Vehicle model exists, skipping
‚úÖ [SUCCESS] C++ compilation completed successfully
üìç Executable: /quickbuild/build/bin/app
üìè Size: 14M
üéâ Build completed successfully!
```

### **Phase 2: Run the Application**

**Using Pre-built Image:**
```bash
# Start the multi-signal processor
docker run -d --network host --name step2-app \
  -v tutorial-build:/quickbuild/build \
  -e SDV_VEHICLEDATABROKER_ADDRESS=127.0.0.1:55555 \
  ghcr.io/tri2510/vehicle-app-cpp-template/velocitas-quick:prerelease-latest run 120
```

**Monitor Application Logs:**
```bash
# Watch multi-signal processing in action
docker logs step2-app --follow
```

**Expected Startup Logs:**
```
üéì Step 2: Starting Multi-Signal Processor Tutorial
üéØ Learning Goal: Master multi-signal correlation
üìä Processing: Speed + RPM + Fuel Level
üéì Step 2: Multi-Signal Processor starting...
üì° Connecting to Vehicle Data Broker...
üöó Learning objective: Process multiple vehicle signals
üìä Signals: Speed, Engine RPM, Fuel Level
‚úÖ Multi-Signal Processor initialized
üöÄ Step 2: Starting Multi-Signal Processor!
‚úÖ Multi-signal subscriptions completed
üîÑ Monitoring: Speed + RPM + Fuel Level
```

### **Phase 3: Multi-Signal Testing**

**Test 1: Individual Signal Updates**
```bash
# First, inject speed signal
echo "setValue Vehicle.Speed 20.0" | docker run --rm -i --network host \
  ghcr.io/eclipse-kuksa/kuksa-python-sdk/kuksa-client:main grpc://127.0.0.1:55555

# Check logs to see partial update
docker logs step2-app --tail 5
```

**Expected Response:**
```
üì° Received multi-signal update
   Speed: 20.00 m/s
üöó Vehicle Status Update:
   üìä Speed: 72.0 km/h | RPM: 0 | Fuel: 0.0%
```

**Test 2: Complete Multi-Signal Update**
```bash
# Inject all three signals
echo "setValue Vehicle.Speed 25.0" | docker run --rm -i --network host \
  ghcr.io/eclipse-kuksa/kuksa-python-sdk/kuksa-client:main grpc://127.0.0.1:55555

echo "setValue Vehicle.Powertrain.Engine.Speed 2500" | docker run --rm -i --network host \
  ghcr.io/eclipse-kuksa/kuksa-python-sdk/kuksa-client:main grpc://127.0.0.1:55555

echo "setValue Vehicle.Powertrain.FuelSystem.Level 75.5" | docker run --rm -i --network host \
  ghcr.io/eclipse-kuksa/kuksa-python-sdk/kuksa-client:main grpc://127.0.0.1:55555

# Check comprehensive status
docker logs step2-app --tail 10
```

**Expected Multi-Signal Response:**
```
üì° Received multi-signal update
   Speed: 25.00 m/s
   RPM: 2500
   Fuel: 75.5%
üöó Vehicle Status Update:
   üìä Speed: 90.0 km/h | RPM: 2500 | Fuel: 75.5%
üéØ Driving Mode Changed: UNKNOWN ‚Üí HIGHWAY_CRUISE
‚úÖ Optimal driving conditions for fuel efficiency
‚õΩ Fuel Efficiency: 6.2 L/100km
üëç Good fuel efficiency
```

**Test 3: City Driving Pattern**
```bash
# Simulate city driving (low speed, higher RPM)
echo "setValue Vehicle.Speed 10.0" | docker run --rm -i --network host \
  ghcr.io/eclipse-kuksa/kuksa-python-sdk/kuksa-client:main grpc://127.0.0.1:55555

echo "setValue Vehicle.Powertrain.Engine.Speed 3500" | docker run --rm -i --network host \
  ghcr.io/eclipse-kuksa/kuksa-python-sdk/kuksa-client:main grpc://127.0.0.1:55555

# Check driving mode detection
docker logs step2-app --tail 8
```

**Expected Pattern Detection:**
```
üöó Vehicle Status Update:
   üìä Speed: 36.0 km/h | RPM: 3500 | Fuel: 75.5%
üéØ Driving Mode Changed: HIGHWAY_CRUISE ‚Üí CITY_AGGRESSIVE
‚õΩ Fuel Efficiency: 10.5 L/100km
üí∏ Poor fuel efficiency - consider adjusting driving style
```

**Test 4: Low Fuel Warning**
```bash
# Test low fuel scenario
echo "setValue Vehicle.Powertrain.FuelSystem.Level 12.0" | docker run --rm -i --network host \
  ghcr.io/eclipse-kuksa/kuksa-python-sdk/kuksa-client:main grpc://127.0.0.1:55555

# Check fuel warning
docker logs step2-app --tail 5
```

**Expected Low Fuel Alert:**
```
üöó Vehicle Status Update:
   üìä Speed: 36.0 km/h | RPM: 3500 | Fuel: 12.0%
‚õΩ Low fuel warning! 12.0% remaining (~60 km range)
```

**Test 5: Aggressive Acceleration Detection**
```bash
# High RPM at low speed
echo "setValue Vehicle.Speed 5.0" | docker run --rm -i --network host \
  ghcr.io/eclipse-kuksa/kuksa-python-sdk/kuksa-client:main grpc://127.0.0.1:55555

echo "setValue Vehicle.Powertrain.Engine.Speed 4500" | docker run --rm -i --network host \
  ghcr.io/eclipse-kuksa/kuksa-python-sdk/kuksa-client:main grpc://127.0.0.1:55555

# Check acceleration warning
docker logs step2-app --tail 5
```

**Expected Acceleration Alert:**
```
üöó Vehicle Status Update:
   üìä Speed: 18.0 km/h | RPM: 4500 | Fuel: 12.0%
‚ö†Ô∏è  Aggressive acceleration detected! RPM: 4500 at 18.0 km/h
```

**Test 6: Comprehensive Status Report**
```bash
# Generate multiple data points for statistics
for i in {1..5}; do
  speed=$((15 + i * 5))
  rpm=$((2000 + i * 200))
  echo "setValue Vehicle.Speed $speed.0" | docker run --rm -i --network host \
    ghcr.io/eclipse-kuksa/kuksa-python-sdk/kuksa-client:main grpc://127.0.0.1:55555
  echo "setValue Vehicle.Powertrain.Engine.Speed $rpm" | docker run --rm -i --network host \
    ghcr.io/eclipse-kuksa/kuksa-python-sdk/kuksa-client:main grpc://127.0.0.1:55555
  sleep 2
done

# Check periodic status report
docker logs step2-app --tail 15
```

**Expected Status Report:**
```
üìä === VEHICLE STATUS REPORT ===
üìà Average Speed: 82.5 km/h
üîß Average RPM: 2800
‚õΩ Fuel Efficiency: 7.8 L/100km
üéØ Driving Mode: HIGHWAY_CRUISE
üìä Data Points: 10
==============================
```

## üîç Code Analysis & Learning Points

### **Key Patterns You Learned:**

**1. Multi-Signal Subscription:**
```cpp
subscribeDataPoints(
    velocitas::QueryBuilder::select(Vehicle.Speed)
        .select(Vehicle.Powertrain.Engine.Speed)     // Chain multiple signals
        .select(Vehicle.Powertrain.FuelSystem.Level)
        .build()
)
```

**2. Individual Signal Processing:**
```cpp
// Each signal validated separately
if (reply.get(Vehicle.Speed)->isValid()) {
    m_vehicleState.speed = reply.get(Vehicle.Speed)->value();
}
if (reply.get(Vehicle.Powertrain.Engine.Speed)->isValid()) {
    m_vehicleState.engineRpm = reply.get(Vehicle.Powertrain.Engine.Speed)->value();
}
```

**3. State Management Structure:**
```cpp
struct VehicleState {
    double speed = 0.0;
    double engineRpm = 0.0;
    double fuelLevel = 0.0;
    bool dataValid = false;
    std::chrono::steady_clock::time_point lastUpdate;
};
```

**4. Multi-Signal Correlation:**
```cpp
// Combine signals for insights
if (speedKmh < 30 && m_vehicleState.engineRpm > 4000) {
    // Aggressive acceleration detected
}
```

**5. Derived Metrics Calculation:**
```cpp
double calculateInstantFuelConsumption(double speed, double rpm) {
    // Fuel efficiency based on speed and RPM
    return baseConsumption * rpmFactor * speedFactor;
}
```

## ‚úÖ Success Criteria Validation

### **‚úÖ Multi-Signal Processing:**
- **PASS**: Three signals subscribed simultaneously
- **PASS**: Individual signal validation working
- **PASS**: State management tracking all signals
- **PASS**: Updates processed as signals arrive

### **‚úÖ Data Correlation:**
- **PASS**: Driving mode detection from speed + RPM
- **PASS**: Fuel efficiency calculation working
- **PASS**: Pattern detection (aggressive acceleration)
- **PASS**: Combined signal alerts functional

### **‚úÖ Advanced Features:**
- **PASS**: Periodic status reports generated
- **PASS**: Statistical averaging implemented
- **PASS**: Low fuel warnings with range estimate
- **PASS**: Comprehensive vehicle state tracking

## üìä Performance Benchmarks

| Metric | Expected Value | Your Result |
|--------|----------------|-------------|
| **Build Time** | 15-30 seconds (cached) | ‚è±Ô∏è _____ |
| **Application Size** | ~14MB | üìè _____ |
| **Signal Response** | <100ms per update | ‚ö° _____ |
| **Memory Usage** | ~80-120MB | üíæ _____ |
| **CPU Usage** | <5% idle, <10% active | üîß _____ |

## üêõ Common Issues & Solutions

### **Issue 1: Missing Signal Data**
```bash
# Verify all signals are being set
echo "getValue Vehicle.Speed" | docker run --rm -i --network host \
  ghcr.io/eclipse-kuksa/kuksa-python-sdk/kuksa-client:main grpc://127.0.0.1:55555

echo "getValue Vehicle.Powertrain.Engine.Speed" | docker run --rm -i --network host \
  ghcr.io/eclipse-kuksa/kuksa-python-sdk/kuksa-client:main grpc://127.0.0.1:55555
```

### **Issue 2: No Driving Mode Changes**
```bash
# Ensure varied speed/RPM combinations
# City: Low speed (10-40 km/h), varying RPM
# Highway: Medium speed (50-90 km/h), steady RPM
# Sport: Any speed with high RPM (>3500)
```

### **Issue 3: No Status Reports**
```bash
# Status reports appear every 10 data points
# Generate more signal updates to trigger report
```

## üßπ Cleanup

```bash
# Stop the application
docker stop step2-app && docker rm step2-app

# Keep persistent volumes for next steps
# docker volume rm tutorial-build tutorial-deps tutorial-vss
```

## üéì Knowledge Check

**Before proceeding to Step 3, ensure you understand:**

1. **Multi-Signal Subscription**: How to chain `.select()` calls for multiple signals
2. **State Management**: Using structures to track multiple related values
3. **Signal Correlation**: Combining signals for pattern detection
4. **Derived Metrics**: Calculating new values from existing signals
5. **Validation Patterns**: Checking each signal individually in callbacks
6. **Statistical Tracking**: Maintaining averages and counts over time

## üöÄ What's Next?

**Ready for Step 3?** You'll learn advanced data analysis and alert systems:

- **Pattern Analysis**: Detect complex driving behaviors over time
- **Alert Framework**: Build multi-tier alert system with priorities
- **Historical Tracking**: Implement rolling windows and trends
- **Predictive Analytics**: Anticipate issues before they occur
- **Business Rules**: Implement sophisticated logic for fleet management

**[Continue to Step 3: Data Analysis & Alerts ‚Üí](Step3_TUTORIAL.md)**

---

## üìà Step 2 Completion Checklist

- ‚úÖ Successfully built Step2_MultiSignalProcessor application
- ‚úÖ Subscribed to three vehicle signals simultaneously
- ‚úÖ Processed speed, RPM, and fuel level together
- ‚úÖ Detected driving modes from signal correlation
- ‚úÖ Calculated fuel efficiency metrics
- ‚úÖ Generated alerts for aggressive driving and low fuel
- ‚úÖ Viewed periodic vehicle status reports
- ‚úÖ Understood multi-signal processing patterns

**üéâ Congratulations! You've mastered multi-signal vehicle data processing!**

---

*üöóüí® Correlate multiple signals for intelligent vehicle insights!*